local Players = game:GetService("Players")
local player = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local leaderstats = player:FindFirstChild("leaderstats")
local rebirthsStat = leaderstats and leaderstats:FindFirstChild("Rebirths")
local muscleEvent = player:FindFirstChild("muscleEvent") or ReplicatedStorage:FindFirstChild("muscleEvent")

local rEvents = ReplicatedStorage:FindFirstChild("rEvents")
local changeSpeedSizeRemote = rEvents and rEvents:FindFirstChild("changeSpeedSizeRemote")
local rebirthRemote = rEvents and rEvents:FindFirstChild("rebirthRemote")
local openFortuneWheelRemote = rEvents and rEvents:FindFirstChild("openFortuneWheelRemote")
local tradeRequestRemote = rEvents and rEvents:FindFirstChild("tradeRequest") 
local addItemRemote = rEvents and rEvents:FindFirstChild("addItemToTrade")
local confirmTradeRemote = rEvents and rEvents:FindFirstChild("confirmTrade")

local displayName = player.DisplayName
if not displayName or displayName == "" then
    displayName = player.Name
end

local title = ("K13 Shi Final Version | Welcome %s"):format(displayName)

local library = loadstring(game:HttpGet("https://raw.githubusercontent.com/CoronaBlanca/Lxbrxrys/refs/heads/main/Xlxrxxm"))()

local window = library:AddWindow(title, {
    main_color = Color3.fromRGB(80, 0, 130),
    min_size = Vector2.new(600, 800),
    can_resize = true,
})

local function gettool()
    for i, v in pairs(player.Backpack:GetChildren()) do
        if v.Name == "Punch" and player.Character:FindFirstChild("Humanoid") then
            player.Character.Humanoid:EquipTool(v)
        end
    end
    if muscleEvent then muscleEvent:FireServer("punch", "leftHand") end
    if muscleEvent then muscleEvent:FireServer("punch", "rightHand") end
end

local function formatNumber(num)
    local numStr = tostring(num)
    local formatted = ""
    local counter = 0
    for i = #numStr, 1, -1 do
        counter = counter + 1
        formatted = numStr:sub(i, i) .. formatted
        if counter % 3 == 0 and i > 1 then
            formatted = "," .. formatted
        end
    end
    return formatted
end

local MainTab = window:AddTab("Main")
local FarmingTab = window:AddTab("Farming") 


MainTab:AddSwitch("Spin Fortune Wheel", function(bool)
    _G.AutoSpinWheel = bool
    if bool and openFortuneWheelRemote then
        task.spawn(function()
            while _G.AutoSpinWheel and task.wait(1) do
                openFortuneWheelRemote:InvokeServer("openFortuneWheel", ReplicatedStorage.fortuneWheelChances["Fortune Wheel"])
            end
        end)
    end
end)

local userSize = 2
local sizeActive = false
MainTab:AddTextBox("Size", function(text)
	text = string.gsub(text, "%s+", "")
	userSize = tonumber(text) or userSize
end)
MainTab:AddSwitch("Set Size", function(bool) sizeActive = bool end)

task.spawn(function()
	while true do
		if sizeActive and changeSpeedSizeRemote then
			local char = player.Character
			if char and char:FindFirstChildOfClass("Humanoid") then
				changeSpeedSizeRemote:InvokeServer("changeSize", userSize)
			end
		end
		task.wait(0.15)
	end
end)

local userSpeed = 120
local speedActive = false
MainTab:AddTextBox("Speed", function(text)
	text = string.gsub(text, "%s+", "")
	userSpeed = tonumber(text) or userSpeed
end)
MainTab:AddSwitch("Set Speed", function(bool) speedActive = bool end)

task.spawn(function()
	while true do
		if speedActive and changeSpeedSizeRemote then
			local char = player.Character
			if char and char:FindFirstChildOfClass("Humanoid") then
				changeSpeedSizeRemote:InvokeServer("changeSpeed", userSpeed)
			end
		end
		task.wait(0.15)
	end
end)

local autoRockFolder = MainTab:AddFolder("Auto Rocks")
autoRockFolder:AddSwitch("Tiny Rock (Dura 0)", function(Value)
    _G.autoFarm = Value
    task.spawn(function()
        while _G.autoFarm do
            task.wait()
            if not _G.autoFarm then break end
            
            if player.Durability and player.Durability.Value >= 0 then
                local machinesFolder = Workspace:FindFirstChild("machinesFolder")
                if machinesFolder then
                    for i, v in pairs(machinesFolder:GetDescendants()) do
                        if v.Name == "neededDurability" and v.Value == 0 then
                            gettool()
                        end
                    end
                end
            end
        end
    end)
end)

local autoEquipToolsFolder = MainTab:AddFolder(" Auto Equip Tools")

autoEquipToolsFolder:AddSwitch("Auto Weight", function(Value)
    _G.AutoWeight = Value
    if Value then
        local weightTool = player.Backpack:FindFirstChild("Weight")
        if weightTool and player.Character and player.Character:FindFirstChild("Humanoid") then 
            player.Character.Humanoid:EquipTool(weightTool) 
        end
        task.spawn(function() 
            while _G.AutoWeight do 
                if muscleEvent then muscleEvent:FireServer("rep") end
                task.wait(0.1) 
            end 
        end)
    else
        local equipped = player.Character and player.Character:FindFirstChild("Weight")
        if equipped then equipped.Parent = player.Backpack end
    end
end)

local working = false
local repTaskMachines = nil
local workoutPositions = {
    ["Bench Press"] = { ["Jungle Gym"] = CFrame.new(-8173, 64, 1898) },
}
local workoutLocations = { "Jungle Gym", "Muscle King Gym" }

MainTab:AddLabel("Machines:").TextSize = 22

local selectedLocation = nil
local selectedWorkout = nil

MainTab:AddSwitch("Start Machine Farm", function(enabled)
    working = enabled
end)

local locationDropdown = MainTab:AddDropdown("Gym Location", function(location) selectedLocation = location end)
for _, location in ipairs(workoutLocations) do locationDropdown:Add(location) end
MainTab:AddDropdown("Workout Machine", function(machine) selectedWorkout = machine end):Add("Bench Press"):Add("Squat")

local rebirthValueLabel = FarmingTab:AddLabel("Rebirths: 0")
rebirthValueLabel.TextSize = 17
local targetLabel =  FarmingTab:AddLabel("Target: None")
targetLabel.TextSize = 17

local targetRebirths = 0
local isAutoRebirthing = false
local rebirthSwitch

local function autoRebirth()
    isAutoRebirthing = true
    while isAutoRebirthing and rebirthsStat and rebirthsStat.Value < targetRebirths do
        if rebirthRemote then rebirthRemote:InvokeServer("rebirthRequest") end
        task.wait(0.05)
    end
    isAutoRebirthing = false
    if rebirthSwitch then rebirthSwitch:Set(false) end
end

FarmingTab:AddTextBox("Set Rebirth Target", function(text)
    local val = tonumber(text)
    if val and val >= 0 then targetRebirths = val end
end)

rebirthSwitch = FarmingTab:AddSwitch("Auto Rebirth", function(enabled)
    if enabled then
        if rebirthsStat and targetRebirths > 0 and rebirthsStat.Value < targetRebirths then
            task.spawn(autoRebirth)
        else
            rebirthSwitch:Set(false)
        end
    else
        isAutoRebirthing = false
    end
end)

task.spawn(function()
    while true do
        if rebirthsStat then
            rebirthValueLabel.Text = "Rebirths: " .. formatNumber(rebirthsStat.Value)
            targetLabel.Text = "Target Rebirths: " .. formatNumber(targetRebirths)
        end
        task.wait(0.2)
    end
end) 

local sizeActiveFarming = false
FarmingTab:AddSwitch("Auto Size 1 (Min)", function(bool) sizeActiveFarming = bool end)

task.spawn(function()
    while true do
        if sizeActiveFarming and changeSpeedSizeRemote then
            local char = player.Character
            if char and char:FindFirstChildOfClass("Humanoid") then
                changeSpeedSizeRemote:InvokeServer("changeSize", 1)
            end
        end
        task.wait(0.05)
    end
end)
